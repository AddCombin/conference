name: Build and Deploy Homepages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 检出 private 仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 安装 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3️⃣ 创建输出目录
      - name: Create output directory
        run: mkdir -p output;
             cp ../*.css .;

      # 4️⃣ 构建每个用户的 HTML
      - name: Build HTML for each user
        run: |
          for dir in */; do
            # 忽略 .github 和 output 文件夹
            if [ "$dir" = ".github/" ] || [ "$dir" = "output/" ]; then
              continue
            fi
            echo "Processing folder: $dir"
            mkdir -p output/"$dir"
            # 调用 Node.js inline 脚本
            node inline.js "$dir/index.html" "output/$dir/index.html"
          done

      # 5️⃣ 复制 PDF 文件到 output
      - name: Copy PDFs
        run: |
          find . -type f -name "*.pdf" | while read pdf; do
            folder=$(dirname "$pdf")
            mkdir -p output/"$folder"
            cp "$pdf" output/"$folder"/
          done

      # 6️⃣ 推送到 public 仓库
      - name: Push to public repo
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.push_to_conference }}
        run: |
          git clone https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/addcombin/conference.git public
          cd public
          rm -rf *
          cp -r ../output/* .
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto update all homepages" || echo "Nothing to commit"
          git push
